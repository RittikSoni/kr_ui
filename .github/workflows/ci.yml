name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  analyze-and-test:
    name: Analyze, Format & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“š Checkout code
        uses: actions/checkout@v4

      - name: ğŸ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: ğŸ“¦ Install Melos
        run: dart pub global activate melos

      - name: ğŸ”§ Bootstrap packages
        run: melos bootstrap

      - name: ğŸ” Run Flutter analyze
        run: melos exec -- flutter analyze
        continue-on-error: false

      - name: ğŸ’… Check formatting
        run: melos exec -- dart format --set-exit-if-changed .
        continue-on-error: false

      - name: ğŸ§ª Run tests with coverage
        run: melos exec --dir-exists=test -- flutter test --coverage
        continue-on-error: false

      - name: ğŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./packages/kr_ui/coverage/lcov.info
          flags: unittests
          name: kr_ui-coverage
          fail_ci_if_error: false
          verbose: true

      - name: ğŸ—ï¸ Build kr_ui_docs (web)
        run: |
          cd apps/kr_ui_docs
          flutter build web --release
        continue-on-error: false

      - name: âœ… All checks passed
        run: echo "All CI checks passed successfully!"
